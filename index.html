<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iGlass AI Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { blue: '#007AFF', indigo: '#5856D6', purple: '#AF52DE', pink: '#FF2D55', green: '#34C759', orange: '#FF9500', teal: '#30B0C7' },
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Inter', 'sans-serif'] },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        blob: { '0%': { transform: 'scale(1)' }, '33%': { transform: 'scale(1.1)' }, '66%': { transform: 'scale(0.9)' }, '100%': { transform: 'scale(1)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; background: #050505; color: white; }

        /* Dynamic Background */
        .mesh-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(at 0% 0%, #000 0, transparent 50%), radial-gradient(at 50% 0%, #1a1a2e 0, transparent 50%); opacity: 0.8; }
        
        /* Glass Components */
        .glass-premium { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s; }
        .glass-card:hover { background: rgba(255, 255, 255, 0.06); }
        .glass-input { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); }
        .glass-input:focus-within { border-color: var(--accent-color, #007AFF); box-shadow: 0 0 0 2px rgba(0,122,255,0.15); }

        /* Message Bubbles */
        .msg-bubble-user { background: var(--accent-gradient, linear-gradient(135deg, #007AFF, #5856D6)); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .msg-bubble-ai { background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Message Actions (Edit/Speak) */
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
        .msg-group:hover .msg-actions { opacity: 1; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        
        /* Code Blocks & Copy */
        pre { margin: 8px 0 !important; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; opacity: 0; transition: 0.2s; }
        pre:hover .copy-btn { opacity: 1; }

        /* Command Palette */
        #cmd-palette { animation: slideUp 0.2s ease-out; }
        .cmd-item.selected { background: rgba(255,255,255,0.1); border-left: 2px solid var(--accent-color, #007AFF); }

        /* Theme Variables (Dynamic) */
        :root { --accent-color: #007AFF; }
        .theme-gpt { --accent-color: #10a37f; --accent-gradient: linear-gradient(135deg, #10a37f, #0d8a6a); }
        .theme-claude { --accent-color: #d97757; --accent-gradient: linear-gradient(135deg, #d97757, #c56545); }
        .theme-deepseek { --accent-color: #007AFF; --accent-gradient: linear-gradient(135deg, #007AFF, #5856D6); }

        /* Mobile Drawer */
        .mobile-sidebar { transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .mobile-sidebar.open { transform: translateX(0); }
        
        /* Loading Dots */
        .typing-dot { width: 4px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body class="theme-deepseek antialiased">

    <div class="mesh-bg"></div>
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-0 left-1/4 w-[500px] h-[500px] bg-blue-500/10 rounded-full blur-[100px] animate-blob"></div>
        <div class="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-purple-500/10 rounded-full blur-[100px] animate-blob" style="animation-delay: 2s"></div>
    </div>

    <div id="drawer-overlay" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>

    <div class="flex h-full w-full p-0 md:p-4 gap-4 max-w-[1800px] mx-auto relative z-10">
        
        <aside id="sidebar" class="mobile-sidebar fixed inset-y-0 left-0 z-50 w-[280px] bg-[#0c0c0e] md:bg-transparent md:static md:flex md:flex-col md:glass-premium md:rounded-[20px] flex flex-col h-full border-r border-white/10 md:border-none shadow-2xl md:shadow-none transition-colors">
            <div class="p-4 pb-2">
                <div class="flex items-center gap-3 mb-4 px-1">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-white/20 to-white/5 flex items-center justify-center border border-white/10">
                        <i class="fa-solid fa-layer-group text-white text-xs"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-sm tracking-wide">iGlass AI</h1>
                        <p class="text-[10px] text-gray-500 font-mono">ULTIMATE</p>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400"><i class="fa-solid fa-chevron-left"></i></button>
                </div>
                
                <button onclick="createNewChat()" class="w-full bg-white/5 hover:bg-white/10 text-white text-xs font-medium py-2.5 rounded-lg border border-white/10 flex items-center justify-center gap-2 transition-all">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>

                <div class="mt-3 relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-xs text-gray-500"></i>
                    <input type="text" id="chat-search" oninput="filterChats(this.value)" placeholder="Search chats..." class="w-full bg-black/20 border border-white/5 rounded-lg pl-8 pr-3 py-2 text-xs text-gray-300 focus:outline-none focus:border-white/20 transition">
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto px-2 space-y-0.5 custom-scrollbar mt-2" id="chat-list"></div>

            <div class="p-3 mt-auto border-t border-white/5">
                <button onclick="openSettings()" class="w-full p-2 rounded-lg flex items-center gap-3 text-xs hover:bg-white/5 transition opacity-80 hover:opacity-100">
                    <i class="fa-solid fa-sliders text-gray-400"></i> Settings & API
                    <div class="ml-auto text-[10px] bg-white/10 px-1.5 rounded text-gray-400 font-mono">âŒ˜K</div>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative w-full h-full md:glass-premium md:rounded-[20px] overflow-hidden bg-black/20">
            
            <header class="h-14 flex items-center justify-between px-4 md:px-6 z-20 border-b border-white/5 bg-black/10 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden w-8 h-8 flex items-center justify-center text-gray-300"><i class="fa-solid fa-bars"></i></button>
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center text-[10px] font-bold ring-2 ring-offset-2 ring-offset-black transition-all" id="profile-ring">GPT</div>
                            <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-black"></div>
                        </div>
                        <div>
                            <div class="font-medium text-sm text-white flex items-center gap-2 cursor-pointer hover:text-gray-300 transition" onclick="toggleCommandPalette()">
                                <span id="header-profile">Select Model</span> <i class="fa-solid fa-chevron-down text-[10px] text-gray-500"></i>
                            </div>
                            <div class="text-[10px] text-gray-500 flex items-center gap-2">
                                <span id="token-count">0 tokens</span>
                                <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                                <span id="model-id-display" class="font-mono">model-id</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleCommandPalette()" class="w-8 h-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-gray-400 transition" title="Command Palette"><i class="fa-solid fa-terminal text-xs"></i></button>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 scroll-smooth">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-0 animate-fade-in">
                    <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-white/10 to-transparent border border-white/10 flex items-center justify-center text-3xl mb-6 shadow-2xl">
                        <i class="fa-solid fa-cube text-white/80"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">How can I help?</h2>
                    <div class="flex gap-3 mt-8">
                        <button class="px-4 py-2 rounded-full glass-card text-xs hover:bg-white/10 transition" onclick="setInput('Analyze this code')">Analyze Code</button>
                        <button class="px-4 py-2 rounded-full glass-card text-xs hover:bg-white/10 transition" onclick="setInput('Write a poem about space')">Creative Writing</button>
                        <button class="px-4 py-2 rounded-full glass-card text-xs hover:bg-white/10 transition" onclick="setInput('Explain Quantum Physics')">Explain Topic</button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-6 left-4 right-4 md:left-20 md:right-20 z-30">
                <div class="glass-input p-1.5 rounded-[26px] shadow-2xl flex flex-col transition-all duration-300" id="input-wrapper">
                    
                    <div id="file-preview-area" class="hidden px-3 pt-2 pb-1 flex gap-2 overflow-x-auto"></div>

                    <div class="flex items-end gap-2 p-1">
                        <button onclick="document.getElementById('file-upload').click()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition shrink-0 mb-1" title="Attach Image or Text">
                            <i class="fa-solid fa-paperclip text-sm"></i>
                        </button>
                        <input type="file" id="file-upload" multiple class="hidden" onchange="handleFileUpload(this)">

                        <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 px-2 py-2.5 max-h-40 text-sm text-white placeholder-gray-500 resize-none outline-none custom-scrollbar" placeholder="Message..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

                        <button id="mic-btn" onclick="toggleVoice()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition shrink-0 mb-1">
                            <i class="fa-solid fa-microphone text-sm"></i>
                        </button>

                        <button onclick="handleSend()" id="send-btn" class="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center shrink-0 hover:scale-105 active:scale-95 transition mb-1 disabled:opacity-50">
                            <i class="fa-solid fa-arrow-up text-sm" id="send-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2 text-[10px] text-gray-600 font-medium tracking-wide">AI can make mistakes. Check important info.</div>
            </div>
        </main>
    </div>

    <div id="cmd-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-start justify-center pt-[15vh]" onclick="toggleCommandPalette()">
        <div class="w-[600px] max-w-[90%] glass-premium rounded-xl overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="cmd-palette" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-white/10 flex items-center gap-3">
                <i class="fa-solid fa-search text-gray-500 ml-2"></i>
                <input type="text" id="cmd-input" placeholder="Type a command..." class="flex-1 bg-transparent border-none outline-none text-sm text-white placeholder-gray-500 h-6">
                <span class="text-[10px] bg-white/10 px-1.5 rounded text-gray-400">ESC</span>
            </div>
            <div class="max-h-[300px] overflow-y-auto p-2" id="cmd-list">
                </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[90] hidden flex items-center justify-center p-4">
        <div class="w-[500px] glass-premium rounded-2xl p-6 relative">
            <button onclick="closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-lg font-bold mb-4">Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold mb-2 block">AI Profiles</label>
                    <div id="profile-list" class="space-y-2 mb-2"></div>
                    <button onclick="document.getElementById('add-profile-form').classList.toggle('hidden')" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1"><i class="fa-solid fa-plus"></i> Add New</button>
                </div>
                <div id="add-profile-form" class="hidden space-y-2 bg-white/5 p-3 rounded-lg border border-white/10">
                    <input id="new-name" placeholder="Name (e.g. GPT-4)" class="w-full bg-black/20 p-2 rounded text-xs border border-white/10 text-white">
                    <input id="new-key" type="password" placeholder="API Key" class="w-full bg-black/20 p-2 rounded text-xs border border-white/10 text-white font-mono">
                    <input id="new-model" placeholder="Model ID (openai/gpt-4o)" class="w-full bg-black/20 p-2 rounded text-xs border border-white/10 text-white font-mono">
                    <button onclick="addProfile()" class="w-full bg-blue-600 hover:bg-blue-500 py-1.5 rounded text-xs font-medium text-white">Save Profile</button>
                </div>
                <div class="pt-4 border-t border-white/10">
                    <button onclick="clearAllChats()" class="text-red-400 text-xs hover:text-red-300">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 glass-premium px-4 py-2 rounded-full flex items-center gap-2 shadow-2xl z-[110] translate-y-[-100px] transition-transform duration-300">
        <i class="fa-solid fa-circle-check text-green-500 text-xs"></i> <span class="text-xs font-medium" id="toast-msg"></span>
    </div>

    <script>
        // --- STATE & CONSTANTS ---
        const DEFAULT_PROFILES = [
            { id: 1, name: "DeepSeek R1", key: "", model: "deepseek/deepseek-r1:free", theme: "theme-deepseek", active: true },
            { id: 2, name: "GPT-4o", key: "", model: "openai/gpt-4o", theme: "theme-gpt", active: false },
            { id: 3, name: "Claude 3.5", key: "", model: "anthropic/claude-3.5-sonnet", theme: "theme-claude", active: false }
        ];

        let state = {
            profiles: JSON.parse(localStorage.getItem('profiles') || JSON.stringify(DEFAULT_PROFILES)),
            chats: JSON.parse(localStorage.getItem('chats') || '[]'),
            currentChatId: null,
            isGenerating: false,
            abortController: null,
            attachments: [] // { type: 'image'|'text', content: 'base64'|'string', name: 'filename' }
        };

        const CMDS = [
            { icon: 'fa-plus', label: 'New Chat', action: createNewChat },
            { icon: 'fa-trash', label: 'Clear Current Chat', action: clearCurrentChat },
            { icon: 'fa-sliders', label: 'Settings', action: openSettings },
            { icon: 'fa-download', label: 'Export Chat', action: exportChat },
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            renderChatList();
            renderProfileList();
            
            if(state.chats.length > 0) loadChat(state.chats[0].id);
            else { 
                document.getElementById('empty-state').style.opacity = '1'; 
                state.currentChatId = null;
            }

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    toggleCommandPalette();
                }
                if(e.key === 'Escape') {
                    document.getElementById('cmd-overlay').classList.add('hidden');
                    document.getElementById('settings-modal').classList.add('hidden');
                }
            });
        });

        // --- THEME & UI ---
        function applyTheme() {
            const p = state.profiles.find(x => x.active);
            if(p) {
                document.body.className = `${p.theme || 'theme-deepseek'} antialiased`;
                document.getElementById('header-profile').innerText = p.name;
                document.getElementById('profile-ring').innerText = p.name.substring(0,2).toUpperCase();
                document.getElementById('profile-ring').style.boxShadow = `0 0 0 2px var(--accent-color)`;
                document.getElementById('model-id-display').innerText = p.model.split('/')[1] || p.model;
            }
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            const chat = { id: Date.now().toString(), title: "New Chat", msgs: [], created: Date.now() };
            state.chats.unshift(chat);
            saveChats();
            loadChat(chat.id);
            if(window.innerWidth < 768) toggleSidebar();
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            renderMessages();
            renderChatList();
            document.getElementById('empty-state').style.display = 'none';
        }

        async function handleSend() {
            if(state.isGenerating) {
                if(state.abortController) state.abortController.abort();
                state.isGenerating = false;
                updateSendBtn();
                return;
            }

            const input = document.getElementById('user-input');
            const txt = input.value.trim();
            const files = [...state.attachments];

            if((!txt && files.length === 0)) return;

            const profile = state.profiles.find(p => p.active);
            if(!profile || !profile.key) { showToast("API Key missing!", "error"); openSettings(); return; }

            // UI Reset
            input.value = '';
            state.attachments = [];
            renderAttachments();
            autoResize(input);
            state.isGenerating = true;
            state.abortController = new AbortController();
            updateSendBtn();

            const chat = state.chats.find(c => c.id === state.currentChatId) || (createNewChat(), state.chats[0]);
            
            // Build Context
            let contextContent = txt;
            if(files.length > 0) {
                // Determine if model supports vision or we append text files
                const visionModel = profile.model.includes('gpt-4') || profile.model.includes('claude') || profile.model.includes('gemini');
                
                // Text files appended directly
                const textFiles = files.filter(f => f.type === 'text');
                textFiles.forEach(f => contextContent += `\n\n[File: ${f.name}]\n\`\`\`\n${f.content}\n\`\`\``);

                // Images handled for API
                const imgFiles = files.filter(f => f.type === 'image');
                if(imgFiles.length > 0 && visionModel) {
                     // Complex object for API (simplified for this demo)
                     // In a real app, structure depends on provider (OpenAI vs Anthropic)
                     // Here we assume OpenRouter/OpenAI format:
                     // content: [{type: "text", text: ...}, {type: "image_url", ...}]
                }
            }

            // User Msg
            chat.msgs.push({ role: 'user', content: contextContent, displayFiles: files });
            renderMessages();

            // AI Msg Placeholder
            const tempId = Date.now();
            chat.msgs.push({ role: 'assistant', content: '', id: tempId, typing: true });
            renderMessages();

            // Auto-Title Trigger (Background)
            if(chat.msgs.length === 2 && chat.title === "New Chat") generateAutoTitle(chat, profile);

            try {
                // Construct Body
                const messages = chat.msgs.filter(m => !m.typing && !m.id).map(m => ({ role: m.role, content: m.content }));
                
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${profile.key}`, 
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href 
                    },
                    body: JSON.stringify({
                        model: profile.model,
                        messages: messages,
                        stream: true
                    }),
                    signal: state.abortController.signal
                });

                if(!res.ok) throw new Error("API Error");

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if(data === '[DONE]') continue;
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices?.[0]?.delta?.content;
                                if(content) {
                                    fullText += content;
                                    const msg = chat.msgs.find(m => m.id === tempId);
                                    if(msg) {
                                        msg.content = fullText;
                                        msg.typing = false;
                                        // Live DOM update
                                        const bubbles = document.querySelectorAll('.msg-bubble-ai .content-area');
                                        const target = bubbles[bubbles.length - 1];
                                        if(target) target.innerHTML = parseMarkdown(fullText);
                                        scrollToBottom();
                                    }
                                }
                            } catch(e){}
                        }
                    }
                }
                
                // Cleanup
                const msg = chat.msgs.find(m => m.id === tempId);
                if(msg) { delete msg.id; delete msg.typing; }
                saveChats();

            } catch(e) {
                if(e.name !== 'AbortError') showToast(e.message, 'error');
            } finally {
                state.isGenerating = false;
                updateSendBtn();
                renderMessages(); // Final render for buttons
            }
        }

        // --- EDIT & REGENERATE ---
        function editMessage(index) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const msg = chat.msgs[index];
            if(!msg || msg.role !== 'user') return;

            // Replace UI with Textarea
            const container = document.getElementById(`msg-${index}`);
            const originalContent = msg.content.split('\n\n[File:')[0]; // Simple strip of appended files for editing logic
            
            container.innerHTML = `
                <div class="glass-card p-2 rounded-xl w-full max-w-2xl ml-auto animate-fade-in">
                    <textarea id="edit-area-${index}" class="w-full bg-black/20 text-white text-sm p-2 rounded outline-none resize-none h-24 border border-white/10 focus:border-blue-500 transition">${originalContent}</textarea>
                    <div class="flex gap-2 justify-end mt-2">
                        <button onclick="renderMessages()" class="px-3 py-1 text-xs rounded bg-white/5 hover:bg-white/10">Cancel</button>
                        <button onclick="saveEdit(${index})" class="px-3 py-1 text-xs rounded bg-blue-600 hover:bg-blue-500 text-white">Save & Regenerate</button>
                    </div>
                </div>
            `;
        }

        function saveEdit(index) {
            const newText = document.getElementById(`edit-area-${index}`).value;
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            // Truncate history
            chat.msgs = chat.msgs.slice(0, index);
            saveChats();
            renderMessages();
            
            // Trigger new send
            document.getElementById('user-input').value = newText;
            handleSend();
        }

        // --- AUTO TITLE ---
        async function generateAutoTitle(chat, profile) {
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${profile.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "google/gemini-2.0-flash-lite-preview-02-05:free", // Use a cheap/free model for titles if possible, else user's model
                        messages: [
                            {role: "system", content: "Summarize conversation in 3-5 words. No quotes."},
                            {role: "user", content: chat.msgs[0].content.slice(0, 500)}
                        ]
                    })
                });
                const data = await res.json();
                const title = data.choices[0].message.content.trim();
                chat.title = title.replace(/"/g, '');
                saveChats();
                renderChatList();
            } catch(e) { console.log("Auto-title failed", e); }
        }

        // --- TTS ---
        function speakMessage(text) {
            if('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.1;
                window.speechSynthesis.speak(u);
            }
        }

        // --- FILES ---
        function handleFileUpload(input) {
            const files = Array.from(input.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const type = file.type.startsWith('image/') ? 'image' : 'text';
                    // For text files, we want the raw string, for images base64
                    if(type === 'text') {
                        // Read as text
                        const textReader = new FileReader();
                        textReader.onload = (ev) => {
                            state.attachments.push({ type: 'text', name: file.name, content: ev.target.result });
                            renderAttachments();
                        };
                        textReader.readAsText(file);
                    } else {
                        state.attachments.push({ type: 'image', name: file.name, content: content });
                        renderAttachments();
                    }
                };
                reader.readAsDataURL(file); // Only needed for preview really
            });
            input.value = '';
        }

        function renderAttachments() {
            const area = document.getElementById('file-preview-area');
            area.innerHTML = '';
            if(state.attachments.length === 0) { area.classList.add('hidden'); return; }
            area.classList.remove('hidden');
            
            state.attachments.forEach((file, idx) => {
                const el = document.createElement('div');
                el.className = 'relative shrink-0 w-16 h-16 rounded-lg border border-white/20 overflow-hidden group bg-black/40 flex items-center justify-center';
                if(file.type === 'image') el.innerHTML = `<img src="${file.content}" class="w-full h-full object-cover">`;
                else el.innerHTML = `<div class="text-[10px] text-center p-1 break-all text-gray-300"><i class="fa-solid fa-file-lines mb-1 block"></i>${file.name.slice(0,8)}...</div>`;
                
                el.innerHTML += `<button onclick="state.attachments.splice(${idx},1);renderAttachments()" class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>`;
                area.appendChild(el);
            });
        }

        // --- RENDERING HELPERS ---
        function renderMessages() {
            const container = document.getElementById('chat-container');
            if(!state.currentChatId) return;
            const chat = state.chats.find(c => c.id === state.currentChatId);
            container.innerHTML = '';

            let totalTokens = 0;

            chat.msgs.forEach((m, i) => {
                totalTokens += m.content.length / 4; // Approx
                
                const div = document.createElement('div');
                div.className = `msg-group flex w-full ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in mb-4 relative`;
                div.id = `msg-${i}`;

                const inner = document.createElement('div');
                inner.className = `max-w-[85%] md:max-w-[70%] p-4 text-sm rounded-2xl shadow-lg relative ${m.role === 'user' ? 'msg-bubble-user text-white rounded-br-sm' : 'msg-bubble-ai text-gray-100 rounded-bl-sm'}`;
                
                let html = '';
                
                // Attachments display
                if(m.displayFiles && m.displayFiles.length) {
                    html += `<div class="flex gap-2 mb-2 flex-wrap">`;
                    m.displayFiles.forEach(f => {
                        if(f.type === 'image') html += `<img src="${f.content}" class="w-32 h-32 rounded border border-white/10 object-cover">`;
                        else html += `<div class="flex items-center gap-2 bg-black/20 px-2 py-1 rounded border border-white/10"><i class="fa-solid fa-file-code text-xs"></i> <span class="text-xs truncate max-w-[100px]">${f.name}</span></div>`;
                    });
                    html += `</div>`;
                }

                if(m.typing) html += `<div class="flex gap-1 py-1"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
                else html += `<div class="content-area prose prose-invert max-w-none prose-sm">${m.role === 'user' ? m.content.replace(/</g, "&lt;") : parseMarkdown(m.content)}</div>`;

                inner.innerHTML = html;
                div.appendChild(inner);

                // Action Buttons
                if(!m.typing) {
                    const actions = document.createElement('div');
                    actions.className = `msg-actions absolute ${m.role === 'user' ? 'left-[-40px] top-2' : 'right-[-40px] top-2'} flex flex-col gap-2`;
                    
                    if(m.role === 'assistant') {
                        actions.innerHTML = `<button onclick="speakMessage(this.parentElement.parentElement.innerText)" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-volume-high text-xs"></i></button>`;
                    } else {
                        actions.innerHTML = `<button onclick="editMessage(${i})" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-pencil text-xs"></i></button>`;
                    }
                    div.appendChild(actions);
                }

                container.appendChild(div);
            });

            document.getElementById('token-count').innerText = `~${Math.round(totalTokens)} toks`;
            
            // Syntax Highlight
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                // Add Copy
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerText = 'Copy';
                btn.onclick = () => { navigator.clipboard.writeText(block.innerText); btn.innerText = 'Copied!'; setTimeout(()=>btn.innerText='Copy',1500); };
                block.parentElement.appendChild(btn);
            });
            
            // Render Math
            renderMathInElement(container, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            scrollToBottom();
        }

        // --- UTILS ---
        function parseMarkdown(text) { return DOMPurify.sanitize(marked.parse(text)); }
        function saveChats() { localStorage.setItem('chats', JSON.stringify(state.chats)); }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 160) + 'px'; }
        function scrollToBottom() { const c = document.getElementById('chat-container'); c.scrollTo({top: c.scrollHeight, behavior: 'smooth'}); }
        function updateSendBtn() {
            const btn = document.getElementById('send-btn');
            const icon = document.getElementById('send-icon');
            if(state.isGenerating) {
                btn.classList.add('bg-red-500'); btn.classList.remove('bg-white');
                icon.className = 'fa-solid fa-stop';
            } else {
                btn.classList.remove('bg-red-500'); btn.classList.add('bg-white');
                icon.className = 'fa-solid fa-arrow-up';
            }
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('hidden'); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function showToast(msg, type) { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = msg;
            t.style.transform = "translate(-50%, 20px)";
            setTimeout(() => t.style.transform = "translate(-50%, -100px)", 3000);
        }

        // --- COMMAND PALETTE ---
        function toggleCommandPalette() {
            const el = document.getElementById('cmd-overlay');
            const pal = document.getElementById('cmd-palette');
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                setTimeout(() => { pal.style.opacity = '1'; pal.style.transform = 'scale(1)'; document.getElementById('cmd-input').focus(); }, 10);
                renderCommands();
            } else {
                pal.style.opacity = '0'; pal.style.transform = 'scale(0.95)';
                setTimeout(() => el.classList.add('hidden'), 200);
            }
        }
        
        function renderCommands() {
            const list = document.getElementById('cmd-list');
            list.innerHTML = '';
            // Commands
            CMDS.forEach(cmd => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 cursor-pointer text-sm text-gray-300 transition';
                item.innerHTML = `<i class="fa-solid ${cmd.icon} w-5"></i> ${cmd.label}`;
                item.onclick = () => { cmd.action(); toggleCommandPalette(); };
                list.appendChild(item);
            });
            // Models
            state.profiles.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 cursor-pointer text-sm text-gray-300 transition border-t border-white/5 mt-1';
                item.innerHTML = `<i class="fa-solid fa-robot w-5 text-[10px]"></i> Switch to ${p.name}`;
                item.onclick = () => { 
                    state.profiles.forEach(px => px.active = false); 
                    p.active = true; 
                    localStorage.setItem('profiles', JSON.stringify(state.profiles));
                    applyTheme(); toggleCommandPalette(); showToast(`Switched to ${p.name}`);
                };
                list.appendChild(item);
            });
        }

        // --- SEARCH ---
        function filterChats(query) {
            const list = document.getElementById('chat-list');
            const chats = state.chats.filter(c => c.title.toLowerCase().includes(query.toLowerCase()));
            list.innerHTML = '';
            chats.forEach(c => {
                const el = document.createElement('div');
                el.className = `p-2 rounded-lg mb-1 cursor-pointer transition text-xs flex justify-between group ${c.id === state.currentChatId ? 'bg-white/10 text-white' : 'text-gray-400 hover:bg-white/5'}`;
                el.innerText = c.title;
                el.onclick = () => loadChat(c.id);
                list.appendChild(el);
            });
        }
        function renderChatList() { filterChats(''); }
        
        // --- PROFILE MGMT ---
        function renderProfileList() {
            const list = document.getElementById('profile-list');
            list.innerHTML = state.profiles.map(p => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded text-xs border ${p.active ? 'border-blue-500' : 'border-transparent'}">
                    <span>${p.name}</span>
                    <button onclick="deleteProfile(${p.id})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }
        function addProfile() {
            const name = document.getElementById('new-name').value;
            const key = document.getElementById('new-key').value;
            const model = document.getElementById('new-model').value;
            if(name && model) {
                state.profiles.push({ id: Date.now(), name, key, model, theme: 'theme-gpt', active: true });
                state.profiles.forEach((p,i) => { if(i !== state.profiles.length-1) p.active=false; });
                localStorage.setItem('profiles', JSON.stringify(state.profiles));
                applyTheme(); renderProfileList(); document.getElementById('add-profile-form').classList.add('hidden');
            }
        }
        function deleteProfile(id) {
            if(confirm('Delete?')) {
                state.profiles = state.profiles.filter(p => p.id !== id);
                if(state.profiles.length && !state.profiles.find(p=>p.active)) state.profiles[0].active = true;
                localStorage.setItem('profiles', JSON.stringify(state.profiles));
                renderProfileList(); applyTheme();
            }
        }
        function clearAllChats() {
             if(confirm('Delete all chats permanently?')) {
                 state.chats = [];
                 localStorage.setItem('chats', '[]');
                 location.reload();
             }
        }
        function clearCurrentChat() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if(chat) { chat.msgs = []; saveChats(); renderMessages(); }
        }
        function exportChat() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if(!chat) return;
            const blob = new Blob([JSON.stringify(chat, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `chat-${chat.title}.json`;
            a.click();
        }
        function setInput(text) { document.getElementById('user-input').value = text; }
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }
    </script>
</body>
</html>
